<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta name="description" content="Horadric AI - AI-powered Diablo loot analyzer. Instant analysis for Diablo 4, D2R, D3, and Diablo Immortal.">
    <meta name="theme-color" content="#d32f2f">
    <meta name="color-scheme" content="dark">
    
    <meta http-equiv="Content-Security-Policy" content="
        default-src 'self'; 
        script-src 'self' https://www.googletagmanager.com https://www.google-analytics.com 'sha256-vvt4KWwuNr51XfE5m+hzeNEGhiOfZzG97ccfqGsPwvE='; 
        style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; 
        font-src 'self' https://fonts.gstatic.com; 
        img-src 'self' data: blob: https://www.google-analytics.com https://d4.maxroll.gg https://statverdict.com; 
        connect-src 'self' https://www.google-analytics.com https://analytics.google.com https://generativelanguage.googleapis.com; 
        base-uri 'self';
    ">
    
    <!-- Optimized preconnect -->
    <link rel="preconnect" href="https://fonts.googleapis.com" crossorigin>
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    
    <!-- DNS prefetch for non-critical -->
    <link rel="dns-prefetch" href="https://www.googletagmanager.com">
    <link rel="dns-prefetch" href="https://generativelanguage.googleapis.com">
    
    <title>Horadric AI - Diablo Loot Analyzer</title>
    
    <!-- Load Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-E1JZ16DMSF"></script>
    <script src="js/gtag.js"></script>
    
    <!-- Optimized font loading with display=swap -->
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@600&family=Outfit:wght@500&display=swap" rel="stylesheet">
    
    <!-- Preload critical CSS -->
    <link rel="preload" href="css/style.css" as="style">
    <link rel="preload" href="css/dashboard.css" as="style">
    
    <!-- Critical CSS -->
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/dashboard.css">
    
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='75' font-size='75' fill='%23d32f2f'>‚öî</text></svg>" type="image/svg+xml">

    <!-- Inline critical styles for immediate render -->
    <style>
        /* Critical layout styles */
        .dashboard-header { height: auto !important; min-height: 60px; padding: 10px 20px; }
        .header-content-custom { 
            display: flex; 
            flex-direction: row; 
            align-items: center; 
            justify-content: space-between; 
            gap: 20px; 
            width: 100%; 
        }
        .header-left { width: auto; margin-right: 0; display: flex; align-items: center; justify-content: flex-start; gap: 10px; }
        .title-text { display: inline-block !important; color: #fff; }
        .header-controls { display: flex; gap: 10px; align-items: center; }
        
        /* Loading skeleton to prevent layout shift */
        .dashboard-card { min-height: 300px; }
        
        @media (max-width: 768px) {
            .header-content-custom { 
                flex-direction: column; 
                align-items: center; 
                justify-content: center; 
                gap: 8px; 
            }
            .header-left { justify-content: center; }
            .dashboard-title { font-size: 1.2rem; display: flex; align-items: center; gap: 8px; }
            body.dashboard-layout { padding-top: 10px; }
        }
    </style>
</head>
<body class="dashboard-layout">
    
    <header class="dashboard-header" role="banner">
        <div class="header-content-custom">
            <div class="header-left">
                <a href="index.html" class="back-link" aria-label="Back to Games">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="m15 18-6-6 6-6"/>
                    </svg>
                </a>
                <h1 class="dashboard-title">
                    <span class="title-icon">üî•</span>
                    <span class="title-text">Horadric AI</span>
                </h1>
            </div>
            <div class="header-controls">
                <select id="game-version" class="game-selector" aria-label="Select game">
                    <option value="d4" selected>Diablo IV</option>
                    <option value="d3">Diablo III</option>
                    <option value="d2r">Diablo II: Resurrected</option>
                    <option value="di">Diablo Immortal</option>
                </select>
                <button id="settings-trigger" class="icon-btn" aria-label="Open settings">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="3"></circle>
                        <path d="M12 1v6m0 6v6m7.071-16.071l-4.243 4.243m-5.656 5.656l-4.243 4.243m16.071 0l-4.243-4.243m-5.656-5.656L1.929 1.929"></path>
                    </svg>
                </button>
                <button id="help-trigger" class="icon-btn" aria-label="Open help">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"></circle>
                        <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path>
                        <line x1="12" y1="17" x2="12.01" y2="17"></line>
                    </svg>
                </button>
            </div>
        </div>
    </header>

    <main class="dashboard-main" id="main-content" role="main">
        <div class="dashboard-grid">
            <div class="dashboard-card scan-card">
                <div class="card-header">
                    <h2 class="card-title"><span class="card-icon">üì∏</span> New Scan</h2>
                </div>
                <div class="card-body">
                    <div class="upload-zone" id="upload-zone">
                        <input type="file" id="image-upload" accept="image/png,image/jpeg,image/jpg,image/webp" class="upload-input" aria-label="Upload item screenshot">
                        <label for="image-upload" class="upload-label">
                            <div class="upload-icon">üì∑</div>
                            <div class="upload-text">Drop image here or click to browse</div>
                            <div class="upload-hint">PNG, JPEG, WebP ‚Ä¢ Max 10MB</div>
                        </label>
                        <img id="image-preview" class="upload-preview" alt="Item preview" style="display: none;">
                    </div>
                    <div class="quick-options">
                        <div class="option-row">
                            <label for="player-class" class="option-label">Class</label>
                            <select id="player-class" class="option-select"><option value="Any">Any Class</option></select>
                        </div>
                    </div>
                    <button id="toggle-advanced" class="advanced-toggle" aria-expanded="false">
                        <span>‚öôÔ∏è Advanced Options</span>
                        <svg class="toggle-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"></polyline></svg>
                    </button>
                    <div id="advanced-panel" class="advanced-panel hidden">
                        <div class="advanced-section">
                            <label class="advanced-label">Build Focus</label>
                            <select id="build-style" class="advanced-select"><option value="">Any Build</option></select>
                        </div>
                        <div class="advanced-section">
                            <label class="advanced-label">Stat Priorities</label>
                            <div class="stat-checkboxes">
                                <label class="stat-checkbox"><input type="checkbox" id="need-str"> Strength</label>
                                <label class="stat-checkbox"><input type="checkbox" id="need-int"> Intelligence</label>
                                <label class="stat-checkbox"><input type="checkbox" id="need-will"> Willpower</label>
                                <label class="stat-checkbox"><input type="checkbox" id="need-dex"> Dexterity</label>
                                <label class="stat-checkbox"><input type="checkbox" id="need-res"> All Resist</label>
                            </div>
                        </div>
                        <div class="advanced-section">
                            <label class="advanced-label">Build Mechanic</label>
                            <select id="key-mechanic" class="advanced-select">
                                <option value="">None</option>
                                <option value="thorns">Thorns Build</option>
                                <option value="low-life">Low Life / Injured</option>
                                <option value="overpower">Overpower Stack</option>
                                <option value="minion-only">Minion Only</option>
                            </select>
                        </div>
                    </div>
                    <div id="image-error" class="message-box error" style="display: none;"></div>
                    <div id="image-success" class="message-box success" style="display: none;"></div>
                    <div id="progress-container" class="progress-container" style="display: none;">
                        <div id="progress-bar" class="progress-bar"></div>
                    </div>
                    <div class="card-actions">
                        <button id="analyze-btn" type="button" class="btn-primary btn-large">üîç Analyze Item</button>
                        <button id="compare-btn" type="button" class="btn-primary btn-large">‚öñÔ∏è Compare Item</button>
                        <button id="demo-btn" type="button" class="btn-secondary">üéÆ Try Demo</button>
                    </div>
                    <div id="loading" class="loading-state" style="display: none;">
                        <div class="loading-spinner"></div>
                        <div class="loading-text">Consulting the archives...</div>
                    </div>
                </div>
            </div>
            
            <div class="dashboard-card recent-card">
                <div class="card-header">
                    <h2 class="card-title">
                        <span class="card-icon">üìú</span> Recent Scans <span id="scan-count" class="count-badge">0</span>
                    </h2>
                    <button id="clear-history" class="btn-text" aria-label="Clear all scans">Clear All</button>
                </div>
                <div class="card-body">
                    <div id="history-list" class="recent-list">
                        <div class="empty-state">
                            <div class="empty-icon">üì≠</div>
                            <div class="empty-text">No scans yet</div>
                            <div class="empty-hint">Upload an item to get started</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div id="results-card" class="dashboard-card results-card" style="display: none;">
                <div class="card-header">
                    <h2 class="card-title"><span class="card-icon">üìä</span> Analysis Results</h2>
                    <button id="close-results" class="btn-icon" aria-label="Close results">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                    </button>
                </div>
                <div class="card-body">
                    <div id="result-area" class="result-content"></div>
                    <div id="price-section" class="price-section" style="display: none;">
                        <div class="price-header">
                            <h3>üí∞ Market Value</h3>
                            <button id="refresh-price-btn" class="btn-icon" aria-label="Refresh price">üîÑ</button>
                        </div>
                        <div id="price-content" class="price-content"></div>
                    </div>
                    <div class="result-actions">
                        <button id="share-btn" class="btn-secondary" aria-label="Copy for Discord">üì¢ Copy for Discord</button>
                        <button id="price-check-btn" class="btn-secondary" aria-label="Check price">üí∞ Check Price</button>
                        <button id="search-trade-btn" class="btn-secondary" aria-label="Search trade">üîç Search Trade</button>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <div id="settings-panel" class="settings-panel">
        <div class="settings-overlay"></div>
        <div class="settings-content">
            <div class="settings-header">
                <h2 class="settings-title">‚öôÔ∏è Settings</h2>
                <button id="settings-close" class="btn-icon" aria-label="Close settings">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                </button>
            </div>
            <div class="settings-body">
                <div class="settings-section">
                    <h3 class="section-title">Gemini API Key</h3>
                    <p class="section-desc">Required for AI-powered analysis</p>
                    <form id="api-key-form">
                        <div class="input-group">
                            <input type="password" id="api-key" name="api-key" class="settings-input" placeholder="Paste your API key here..." autocomplete="off">
                            <span class="input-hint">üîí Encrypted & stored locally</span>
                        </div>
                    </form>
                    <a href="https://aistudio.google.com/app/apikey" target="_blank" class="btn-link" rel="noopener noreferrer">Get API Key ‚Üí</a>
                    <div id="api-key-error" class="message-box error" style="display: none;"></div>
                    <div id="api-key-success" class="message-box success" style="display: none;"></div>
                </div>
                <div class="settings-section">
                    <h3 class="section-title">Preferences</h3>
                    <label class="setting-item"><input type="checkbox" id="auto-save-scans" checked> <span>Auto-save scan results</span></label>
                    <label class="setting-item"><input type="checkbox" id="show-prices" checked> <span>Show market prices</span></label>
                </div>
                <div class="settings-section">
                    <h3 class="section-title">About</h3>
                    <p class="about-text">Horadric AI v2.6.3 (CSP-Compliant)</p>
                    <p class="about-text">Made with ‚ù§Ô∏è for Sanctuary</p>
                    <div class="settings-links">
                        <a href="https://forms.gle/4r3pkCsFuD4Ckaqa8" target="_blank" class="settings-link">üêõ Report Issue</a>
                        <a href="https://forms.gle/MappsrQeiSyskmYb6" target="_blank" class="settings-link">üí° Submit Enhancement</a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="help-modal" class="modal-overlay">
        <div class="modal-content">
            <button id="modal-close-btn" class="modal-close" aria-label="Close">√ó</button>
            <div id="modal-content-dynamic"></div>
        </div>
    </div>

    <!-- Load config.js FIRST (must be available before app.js) -->
    <script src="js/config.js"></script>
    
    <!-- Load other dependencies -->
    <script defer src="js/translations.js"></script>
    <script defer src="js/pricing.js"></script>
    
    <!-- Lower priority scripts -->
    <script defer src="js/analytics.js"></script>
    <script defer src="js/tour.js"></script>
    <script defer src="js/i18n-ui.js"></script>
    
    <!-- Main app script must load last -->
    <script defer src="js/app.js"></script>
    
</body>
</html>